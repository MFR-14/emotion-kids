function getAnswers() {
  return JSON.parse(localStorage.getItem("ek_answers") || "[]");
}

function groupCounts(arr) {
  const m = {};
  for (const x of arr) m[x.emosi] = (m[x.emosi] || 0) + 1;
  return m;
}

function topEmotion(counts) {
  let best = null;
  let bestN = -1;
  for (const k of Object.keys(counts)) {
    if (counts[k] > bestN) {
      bestN = counts[k];
      best = k;
    }
  }
  return best ? `${best} (${bestN}x)` : "-";
}

function fmt(n) {
  return (Math.round(n * 100) / 100).toFixed(2);
}

function render() {
  const nama = localStorage.getItem("ek_nama") || "A01";
  const sesi = localStorage.getItem("ek_sesi") || "S1";
  const answers = getAnswers();

  document.getElementById("rekapNama").textContent = nama;
  document.getElementById("rekapSesi").textContent = sesi;
  document.getElementById("rekapJumlah").textContent = String(answers.length);

  const avg = answers.length
    ? answers.reduce((a, b) => a + (Number(b.waktu) || 0), 0) / answers.length
    : 0;

  document.getElementById("rekapRata2").textContent = `${fmt(avg)} dtk`;

  const counts = groupCounts(answers);
  document.getElementById("rekapTop").textContent = topEmotion(counts);

  // detail list
  const list = document.getElementById("rekapList");
  list.innerHTML = "";

  // urutkan terbaru di atas
  const sorted = [...answers].reverse();

  sorted.forEach((x) => {
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div class="a">
        <div class="t">${x.emosi}</div>
        <div class="s">Level ${x.level} • Soal ${x.soal} • ${fmt(Number(x.waktu) || 0)} dtk</div>
      </div>
      <div class="b">${new Date(x.ts).toLocaleString("id-ID")}</div>
    `;
    list.appendChild(row);
  });
}

function resetAll() {
  // reset jawaban + progress level
  localStorage.removeItem("ek_answers");
  localStorage.removeItem("ek_levels_done");
  // tetap simpan nama/sesi biar enak (kalau mau ikut reset juga, hapus 2 baris bawah)
  // localStorage.removeItem("ek_nama");
  // localStorage.removeItem("ek_sesi");
  window.location.href = "index.html";
}

function goHome() {
  window.location.href = "index.html";
}

// expose
window.resetAll = resetAll;
window.goHome = goHome;

render();
